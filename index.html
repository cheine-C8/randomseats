<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Table Sorter</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        main {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px 32px;
            max-width: 900px; /* Max width */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            color: #1a1a1a;
            text-align: center;
            margin-top: 0;
            display: flex; /* Flex to align version number */
            justify-content: center;
            align-items: center;
            gap: 10px; /* Space between title and version */
        }
        .version {
            font-size: 0.8rem;
            font-weight: 600;
            color: #fff;
            background-color: #007aff;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }


        p {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .input-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .input-section > div {
            flex: 1;
            min-width: 280px; /* Ensure inputs don't get too small */
        }

        /* Section for Google Sheet input */
        .sheet-input {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 16px;
        }
        .sheet-input-controls {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .sheet-input-controls > div {
            flex: 1 1 auto;
        }
        .sheet-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .sheet-input input[type="url"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        /* Style for disabled URL input */
        .sheet-input input[type="url"]:disabled {
            background-color: #eee;
            color: #777;
        }
        
        /* Styles for the checkbox */
        .default-sheet-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .default-sheet-toggle label {
            margin-bottom: 0; /* Override other label styles */
            font-weight: 400; /* Lighter font */
            font-size: 0.9rem;
            color: #333;
            cursor: pointer;
        }
        .default-sheet-toggle input[type="checkbox"] {
            cursor: pointer;
        }


        .sheet-input select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #fff;
            box-sizing: border-box; 
            min-width: 150px; 
        }
        .sheet-input button {
            width: auto;
            padding: 10px 14px; 
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 0; 
            background-color: #28a745; /* Green */
            height: 40px; 
        }
        .sheet-input button:hover {
            background-color: #218838;
        }
        #fetchStatus {
            font-size: 0.85rem;
            font-style: italic;
            margin-top: 10px;
            color: #555;
            min-height: 1.2em; /* Reserve space for message */
        }

        textarea {
            width: 100%;
            min-height: 180px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
            font-family: monospace;
            box-sizing: border-box;
            resize: vertical;
        }

        .settings label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .settings .setting-note {
             font-size: 0.85rem; color: #666; font-style: italic;
        }

        .settings input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .sort-button {
            display: block;
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            background-color: #007aff; /* Blue */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 16px;
        }

        .sort-button:hover {
            background-color: #0056b3;
        }

        h2 {
            margin-top: 24px;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            text-align: center;
        }

        /* --- UPDATED Classroom Layout Grid (4 columns) --- */
        #tablesContainer {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr; /* 4 columns */
            grid-template-rows: auto auto;    /* 2 rows */
            grid-template-areas: 
                "table1 table2 table3 table4"
                "desk   table6 board  table5";
            gap: 20px;
            margin-top: 20px;
            background-color: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
        }

        /* Placeholder styles */
        .grid-placeholder {
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 500;
            color: #888;
            padding: 20px;
            text-align: center;
            min-height: 150px;
            background-color: #fdfdfd;
        }
        .desk { grid-area: desk; }
        .smart-board { grid-area: board; }

        /* Assign tables to grid areas */
        [data-table-index="0"] { grid-area: table1; } /* Table 1 */
        [data-table-index="1"] { grid-area: table2; } /* Table 2 */
        [data-table-index="2"] { grid-area: table3; } /* Table 3 */
        [data-table-index="3"] { grid-area: table4; } /* Table 4 */
        [data-table-index="4"] { grid-area: table5; } /* Table 5 */
        [data-table-index="5"] { grid-area: table6; } /* Table 6 */


        .table-group {
            background-color: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            box-sizing: border-box;
            min-width: 0; /* Override old min-width */
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: background-color 0.2s ease, border-color 0.2s ease;
            min-height: 150px; /* Ensure consistent height */
        }
        
        /* Responsive adjustments for the new grid */
        @media (max-width: 768px) {
            #tablesContainer {
                grid-template-columns: 1fr 1fr; /* 2 columns */
                grid-template-areas: 
                    "table1 table2"
                    "table3 table4"
                    "table5 table6"
                    "desk   board";
            }
        }

        @media (max-width: 500px) {
            #tablesContainer {
                grid-template-columns: 1fr; /* 1 column */
                grid-template-areas: 
                    "table1"
                    "table2"
                    "table3"
                    "table4"
                    "table5"
                    "table6"
                    "desk"
                    "board";
            }
            .input-section {
                flex-direction: column;
            }
        }


        .table-group h3 {
            margin-top: 0;
            color: #007aff;
            font-size: 1.3rem;
            margin-bottom: 5px; /* Reduced margin */
            pointer-events: none; 
            text-align: center; /* Center title */
        }
        
        /* Style for the student count */
        .student-count {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
            pointer-events: none;
        }

        .table-group ol {
            padding-left: 20px;
            margin: 0;
            list-style-type: decimal;
            width: 100%;
            min-height: 50px; 
            border-radius: 6px;
        }

        .table-group li {
            font-size: 1.05rem;
            padding: 8px 6px;
            border-bottom: 1px solid #f9f9f9;
            cursor: move; 
            transition: opacity 0.2s ease, background-color 0.2s ease;
            background-color: #fff;
            border-radius: 4px;
            margin-bottom: 2px;
        }
        
        .table-group li:last-child {
            border-bottom: none;
        }

        /* --- Drag and Drop Styles --- */
        li.dragging {
            opacity: 0.4; 
        }
        
        .table-group.drag-over {
            background-color: #e6f7ff; 
            border-color: #007aff;
        }
        .table-group.drag-over-full {
             background-color: #ffebee; 
            border-color: #f44336;
        }


        #emptyState {
            text-align: center;
            color: #777;
            margin-top: 30px;
            font-style: italic;
        }
    </style>
</head>
<body>

    <main>
        <h1>Classroom Table Sorter 👨‍🏫 <span class="version">v1.11.67</span></h1>
        
        <div class="sheet-input">
            <label for="sheetUrl">Import from Google Sheet:</label>
            <p>Publish your sheet to the web as a .csv (File > Share > Publish to the web) and paste the public URL here. Your sheet's **first row must have headers** that match the period names (e.g., "1st period", "2nd period").</p>
            <input type="url" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
            
            <!-- Checkbox for default URL -->
            <div class="default-sheet-toggle">
                <input type="checkbox" id="useDefaultSheet" onchange="toggleDefaultSheet()">
                <label for="useDefaultSheet">Use default class roster</label>
            </div>
            
            <div class="sheet-input-controls">
                <div>
                    <label for="periodSelect" style="margin-top:10px;">Select Period:</label>
                    <select id="periodSelect">
                        <option value="">-- Select a period --</option>
                        <option value="1st period">1st period</option>
                        <option value="2nd period">2nd period</option>
                        <option value="4th period">4th period</option>
                        <option value="5th period">5th period</option>
                        <option value="8th period">8th period</option>
                    </select>
                </div>
                
                <button onclick="fetchFromSheet()">Fetch Names</button>
            </div>
            <div id="fetchStatus"></div>
        </div>

        <div classs="divider"></div>

        <div class="input-section">
            <div>
                <p><strong>...or paste names manually:</strong></p>
                <textarea id="studentNames" placeholder="Alice
Bob
Charlie
..."></textarea>
            </div>
            <div class="settings">
                <p><strong>Settings:</strong></p>
                <label for="numTables">Number of Tables:</label>
                <input type="number" id="numTables" value="6" min="1" max="6"><br><br>
                <label for="maxStudentsPerTable">Max Students per Table:</label>
                <input type="number" id="maxStudentsPerTable" value="5" min="1">
                <p class="setting-note">Note: Only tables 2, 3, and 4 can have more than 4 students. Other tables are capped at 4.</p>
            </div>
        </div>

        <button class="sort-button" onclick="sortTables()">Sort Tables!</button>

        <h2 id="resultsHeader" style="display: none;">Assigned Seating Chart (Drag names to move)</h2>
        <div id="emptyState">Enter names and click "Sort Tables!" to see the seating arrangement.</div>
        <div id="tablesContainer">
            <!-- UPDATED: Static placeholders are now part of the HTML -->
            <div class="grid-placeholder desk">Mr. Heine</div>
            <div class="grid-placeholder smart-board">Smart Board</div>
            <!-- Content generated by JS will be added here -->
        </div>
    </main>

    <script>
        // --- Global state to hold sorting data ---
        let currentSeatingChart = [];
        let currentTableCaps = [];
        let currentActiveTableIndices = []; // Keep track of which tables are active
        let statusEl; // To show messages

        // --- Drag and Drop State ---
        let draggedItem = null;
        let dragSourceTableIndex = -1;
        
        // --- Default URL Constant ---
        const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTv9TCxkcbkdnsITMzUucfYEacC-yfxpR_sNj2k-AxHGjzClPkZqTJtusRqeKBNSud2svCJSY-dcNcL/pub?output=csv';


        /**
         * Toggles the default URL checkbox
         */
        function toggleDefaultSheet() {
            const checkbox = document.getElementById('useDefaultSheet');
            const urlInput = document.getElementById('sheetUrl');
            
            if (checkbox.checked) {
                urlInput.value = DEFAULT_SHEET_URL;
                urlInput.disabled = true;
                localStorage.setItem('classroomSorterUseDefault', 'true');
            } else {
                urlInput.disabled = false;
                // Restore user's custom URL if they had one
                const savedUrl = localStorage.getItem('classroomSorterSheetUrl');
                urlInput.value = savedUrl || ''; // Restore it or clear it
                localStorage.setItem('classroomSorterUseDefault', 'false');
            }
        }

        /**
         * Determines which tables (by 0-based index) are active
         * based on the number of tables selected.
         * Removal order: T1(0), T6(5), T5(4), T4(3), T3(2), T2(1)
         */
        function getActiveTableIndices(numTables) {
            const allIndices = [0, 1, 2, 3, 4, 5]; // Corresponds to tables 1-6
            // 0-based index removal order:
            const removalOrder = [0, 5, 4, 3, 2, 1]; 

            const numToRemove = 6 - numTables;
            if (numToRemove <= 0) return allIndices; // Use all 6
            if (numToRemove >= 6) return []; // Use 0

            const tablesToRemove = removalOrder.slice(0, numToRemove);
            return allIndices.filter(index => !tablesToRemove.includes(index));
        }

        // Fetches and parses the Google Sheet CSV
        async function fetchFromSheet() {
            const urlInput = document.getElementById('sheetUrl');
            const url = urlInput.value;
            statusEl = document.getElementById('fetchStatus'); // Init statusEl
            const textarea = document.getElementById('studentNames');
            const selectedPeriod = document.getElementById('periodSelect').value; 

            if (!url) {
                statusEl.textContent = 'Please paste a URL first.';
                statusEl.style.color = 'red';
                return;
            }
            if (!selectedPeriod) {
                statusEl.textContent = 'Please select a period to fetch.';
                statusEl.style.color = 'red';
                return;
            }
            if (!url.includes('docs.google.com/spreadsheets') || !url.includes('pub?output=csv')) {
                 statusEl.textContent = 'Error: URL must be a "Published to the web" CSV link.';
                 statusEl.style.color = 'red';
                 return;
            }

            statusEl.textContent = 'Fetching names...';
            statusEl.style.color = '#555';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Network error: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV file is empty or has no data rows.');
                }
                
                const headerRow = lines[0];
                const headers = headerRow.split(',').map(h => h.trim().toLowerCase());
                const columnIndex = headers.indexOf(selectedPeriod.toLowerCase());
                
                if (columnIndex === -1) {
                    throw new Error(`Could not find a column named "${selectedPeriod}". Check your sheet's first row for matching headers.`);
                }

                const names = lines.slice(1)
                                     .map(row => {
                                        const columns = row.split(',');
                                        if (columns.length > columnIndex && columns[columnIndex]) {
                                            return columns[columnIndex].trim().replace(/"/g, ''); // Remove quotes
                                        }
                                        return ''; 
                                     })
                                     .filter(name => name.length > 0);

                if (names.length === 0) {
                    throw new Error(`No names found in the "${selectedPeriod}" column.`);
                }
                
                textarea.value = names.join('\n');
                statusEl.textContent = `Successfully imported ${names.length} names!`;
                statusEl.style.color = 'green';

            } catch (error) {
                console.error('Fetch error:', error);
                statusEl.textContent = `Error: Could not fetch names. ${error.message}`;
                statusEl.style.color = 'red';
            }
        }

        // Main sorting function
        function sortTables() {
            const namesInput = document.getElementById('studentNames').value;
            const numTables = parseInt(document.getElementById('numTables').value);
            const maxStudentsPerTable = parseInt(document.getElementById('maxStudentsPerTable').value);

            const names = namesInput.split('\n')
                                  .map(name => name.trim())
                                  .filter(name => name.length > 0);

            statusEl = document.getElementById('fetchStatus'); // Init statusEl
            statusEl.textContent = ''; // Clear status on sort

            if (names.length === 0) {
                statusEl.textContent = 'Please enter or fetch some student names before sorting!';
                statusEl.style.color = 'red';
                return;
            }
            if (isNaN(numTables) || numTables < 1 || numTables > 6) {
                statusEl.textContent = 'Please enter a valid number of tables (1 to 6).';
                statusEl.style.color = 'red';
                return;
            }
            if (isNaN(maxStudentsPerTable) || maxStudentsPerTable < 1) {
                statusEl.textContent = 'Please enter a valid max students per table (1 or more).';
                statusEl.style.color = 'red';
                return;
            }

            // Get the list of which table indices are active
            currentActiveTableIndices = getActiveTableIndices(numTables);
            if (currentActiveTableIndices.length === 0) {
                 statusEl.textContent = 'Error: No tables selected. Please set "Number of Tables" to 1 or more.';
                statusEl.style.color = 'red';
                return;
            }

            // Define individual table caps for ALL 6 tables
            currentTableCaps = Array.from({ length: 6 }, (_, i) => {
                const tableNum = i + 1; // 1-based index
                if (tableNum === 2 || tableNum === 3 || tableNum === 4) {
                    return maxStudentsPerTable; // These tables can have the max
                } else {
                    return Math.min(4, maxStudentsPerTable); // Others capped at 4
                }
            });

            // Calculate total capacity based on ACTIVE tables only
            const totalCapacity = currentActiveTableIndices.reduce((acc, tableIndex) => acc + currentTableCaps[tableIndex], 0);

            if (names.length > totalCapacity) {
                statusEl.textContent = `Error: You have ${names.length} students but only capacity for ${totalCapacity} based on table rules. Adjust settings.`;
                statusEl.style.color = 'red';
                return;
            }

            // Shuffle the names
            for (let i = names.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [names[i], names[j]] = [names[j], names[i]];
            }

            // Distribute students only among active tables
            const tables = Array.from({ length: 6 }, () => []); // Always 6 tables
            let distributionIndex = 0;
            names.forEach(name => {
                // Get the real table index from our active list
                const tableIndex = currentActiveTableIndices[distributionIndex % currentActiveTableIndices.length];
                tables[tableIndex].push(name);
                distributionIndex++;
            });

            // Re-distribute to respect *individual* table caps, only checking active tables
            let needsRebalancing = true;
            let rebalanceLoopGuard = 0; 
            while(needsRebalancing && rebalanceLoopGuard < (names.length * 2)) {
                needsRebalancing = false;
                rebalanceLoopGuard++;
                
                // Iterate over active tables
                for (const i of currentActiveTableIndices) {
                    const currentTableCap = currentTableCaps[i]; 
                    
                    while (tables[i].length > currentTableCap) { 
                        needsRebalancing = true;
                        const studentToMove = tables[i].pop();
                        
                        let targetTableIndex = -1;
                        let minStudents = maxStudentsPerTable + 1; 

                        // Find a new spot, but only in other active tables
                        for (const j of currentActiveTableIndices) {
                            if (i === j) continue; // Don't move to same table
                            const targetCap = currentTableCaps[j];
                            if (tables[j].length < targetCap && tables[j].length < minStudents) {
                                minStudents = tables[j].length;
                                targetTableIndex = j;
                            }
                        }

                        if (targetTableIndex !== -1) {
                            tables[targetTableIndex].push(studentToMove);
                        } else {
                            console.warn("Could not find a place for student after rebalancing.");
                            tables[i].push(studentToMove); // Add it back
                            needsRebalancing = false; // Stop loop
                            break; 
                        }
                    }
                }
            }
            
            // Save to global state and render
            currentSeatingChart = tables;
            renderTables(currentSeatingChart);

            // Show results header and hide empty state
            document.getElementById('resultsHeader').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        /**
         * Renders the tables and attaches all DnD event listeners
         */
        function renderTables(tables) {
            const tablesContainer = document.getElementById('tablesContainer');
            
            // UPDATED: Remove only old table groups, not placeholders
            tablesContainer.querySelectorAll('.table-group').forEach(tableEl => {
                tableEl.remove();
            });

            tables.forEach((tableStudents, index) => {
                // Only render tables that are currently active
                if (!currentActiveTableIndices.includes(index)) {
                    return; 
                }

                const tableGroup = document.createElement('div');
                tableGroup.className = 'table-group';
                tableGroup.dataset.tableIndex = index; // Store index

                const tableTitle = document.createElement('h3');
                tableTitle.textContent = `Table ${index + 1}`;
                tableGroup.appendChild(tableTitle);
                
                // Add student count span
                const countSpan = document.createElement('span');
                countSpan.className = 'student-count';
                countSpan.textContent = `(${tableStudents.length} students)`;
                tableGroup.appendChild(countSpan);


                const studentList = document.createElement('ol');
                studentList.dataset.tableIndex = index; // Store index
                
                if (tableStudents.length > 0) {
                    tableStudents.forEach(student => {
                        const li = document.createElement('li');
                        li.textContent = student;
                        li.draggable = true;
                        li.dataset.studentName = student; // Store name
                        
                        // Add drag listeners to each student item
                        li.addEventListener('dragstart', handleDragStart);
                        li.addEventListener('dragend', handleDragEnd);
                        
                        studentList.appendChild(li);
                    });
                }
                tableGroup.appendChild(studentList);

                // Add drop listeners to the table group
                tableGroup.addEventListener('dragover', handleDragOver);
                tableGroup.addEventListener('dragenter', handleDragEnter);
                tableGroup.addEventListener('dragleave', handleDragLeave);
                tableGroup.addEventListener('drop', handleDrop);

                // Append the new table group to the container
                tablesContainer.appendChild(tableGroup);
            });
        }


        // --- Drag and Drop Event Handlers ---

        function handleDragStart(e) {
            draggedItem = e.target;
            dragSourceTableIndex = parseInt(draggedItem.closest('.table-group').dataset.tableIndex, 10);
            
            // Set data (student name)
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.dataset.studentName);

            // Add visual cue
            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            // Clean up visual cues
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            draggedItem = null;
            dragSourceTableIndex = -1;
            
            // Remove all drop highlights
            document.querySelectorAll('.table-group.drag-over, .table-group.drag-over-full').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-full');
            });
        }

        /* UPDATED: handleDragOver now manages visual feedback */
        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const dropTarget = e.target.closest('.table-group');
            
            // If not over a valid table, do nothing and show 'no-drop' cursor
            if (!dropTarget) {
                e.dataTransfer.dropEffect = 'none';
                return;
            }

            // Remove highlights from all *other* tables
            document.querySelectorAll('.table-group.drag-over, .table-group.drag-over-full').forEach(el => {
                if (el !== dropTarget) {
                    el.classList.remove('drag-over', 'drag-over-full');
                }
            });

            const toTableIndex = parseInt(dropTarget.dataset.tableIndex, 10);
            
            // Gracefully handle if table data isn't ready
            if (isNaN(toTableIndex) || !currentTableCaps[toTableIndex] || !currentSeatingChart[toTableIndex]) {
                 e.dataTransfer.dropEffect = 'none';
                 return;
            }
            
            const toTableCap = currentTableCaps[toTableIndex];
            const toTableCurrentSize = currentSeatingChart[toTableIndex].length;

            // Show 'full' highlight
            if (toTableCurrentSize >= toTableCap && dragSourceTableIndex !== toTableIndex) {
                dropTarget.classList.add('drag-over-full');
                dropTarget.classList.remove('drag-over');
                e.dataTransfer.dropEffect = 'no-drop';
            } else { // Show 'allowed' highlight
                dropTarget.classList.add('drag-over');
                dropTarget.classList.remove('drag-over-full');
                e.dataTransfer.dropEffect = 'move';
            }
        }

        /* UPDATED: handleDragEnter is now simpler */
        function handleDragEnter(e) {
            e.preventDefault();
            // Logic is now in handleDragOver for smoother feedback
        }

        /* UPDATED: handleDragLeave now checks if we left the container */
        function handleDragLeave(e) {
            // Find the table group we are leaving
            const dropTarget = e.target.closest('.table-group');
            if (dropTarget) {
                // Determine the element we are entering *next*
                const relatedTarget = e.relatedTarget;
                
                // If we are not moving to another element *within* the same table group...
                if (!relatedTarget || !dropTarget.contains(relatedTarget)) {
                     // ...then remove the highlight
                    dropTarget.classList.remove('drag-over', 'drag-over-full');
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation(); // Stop browser from redirecting
            statusEl.textContent = ''; // Clear any old errors

            const dropTarget = e.target.closest('.table-group');
            if (!dropTarget || !draggedItem) return;

            const toTableIndex = parseInt(dropTarget.dataset.tableIndex, 10);
            const studentName = e.dataTransfer.getData('text/plain');
            
            // --- Validation and Data Update ---

            // 1. Check if dropping in the same table
            if (dragSourceTableIndex === toTableIndex) {
                return; // No change needed
            }

            // 2. Check capacity rules
            const toTableCap = currentTableCaps[toTableIndex];
            const toTableCurrentSize = currentSeatingChart[toTableIndex].length;

            if (toTableCurrentSize >= toTableCap) {
                statusEl.textContent = `Error: Table ${toTableIndex + 1} is full (Max: ${toTableCap}).`;
                statusEl.style.color = 'red';
                return; // Abort drop
            }

            // 3. Update the data model (currentSeatingChart)
            // Remove from old table
            const studentIndex = currentSeatingChart[dragSourceTableIndex].indexOf(studentName);
            if (studentIndex > -1) {
                currentSeatingChart[dragSourceTableIndex].splice(studentIndex, 1);
            }

            // Add to new table
            currentSeatingChart[toTableIndex].push(studentName);

            // 4. Re-render the entire chart
            renderTables(currentSeatingChart);
        }

        // Run once on load
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('emptyState').style.display = 'block';
             document.getElementById('resultsHeader').style.display = 'none';
             statusEl = document.getElementById('fetchStatus'); // Init statusEl

             const urlInput = document.getElementById('sheetUrl');
             const checkbox = document.getElementById('useDefaultSheet');
             
             // Check saved preference for default sheet
             const useDefault = localStorage.getItem('classroomSorterUseDefault') === 'true';
             
             if (useDefault) {
                checkbox.checked = true;
                urlInput.value = DEFAULT_SHEET_URL;
                urlInput.disabled = true;
             } else {
                checkbox.checked = false;
                // Get user's custom saved URL
                const savedUrl = localStorage.getItem('classroomSorterSheetUrl');
                urlInput.value = savedUrl || '';
                urlInput.disabled = false;
             }
             
             // Add listener to save custom URL *only* if box is unchecked
             urlInput.addEventListener('input', () => {
                if (!checkbox.checked) {
                    localStorage.setItem('classroomSorterSheetUrl', urlInput.value);
                }
             });
        });
    </script>

</body>
</html>

