<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Table Sorter</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        main {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px 32px;
            max-width: 900px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            color: #1a1a1a;
            text-align: center;
            margin-top: 0;
        }
        
        /* UPDATED style for version number */
        h1 span.version {
            font-size: 0.5em;
            color: #999;
            font-weight: 400;
            vertical-align: middle;
            margin-left: 8px;
        }

        p {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .input-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .input-section > div {
            flex: 1;
            min-width: 280px; /* Ensure inputs don't get too small */
        }

        /* New section for Google Sheet input */
        .sheet-input {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 16px;
        }
        .sheet-input-controls {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .sheet-input-controls > div {
            flex: 1 1 auto;
        }
        .sheet-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .sheet-input input[type="url"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        /* New style for the select dropdown */
        .sheet-input select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #fff;
            box-sizing: border-box; /* Added for consistency */
            min-width: 150px; /* Ensure it doesn't get too small */
        }
        .sheet-input button {
            width: auto;
            padding: 10px 14px; /* Matched height of inputs */
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 0; /* Handled by flex gap */
            background-color: #28a745; /* Green */
            height: 40px; /* Explicit height */
        }
        .sheet-input button:hover {
            background-color: #218838;
        }
        #fetchStatus {
            font-size: 0.85rem;
            font-style: italic;
            margin-top: 10px;
            color: #555;
            min-height: 1.2em; /* Reserve space for message */
        }

        textarea {
            width: 100%;
            min-height: 180px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
            font-family: monospace;
            box-sizing: border-box;
            resize: vertical;
        }

        .settings label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .settings .setting-note {
             font-size: 0.85rem; color: #666; font-style: italic;
        }

        .settings input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .sort-button {
            display: block;
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            background-color: #007aff; /* Blue */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 16px;
        }

        .sort-button:hover {
            background-color: #0056b3;
        }

        h2 {
            margin-top: 24px;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            text-align: center;
        }

        #tablesContainer {
            display: grid;
            /* Recreate the classroom layout from the image */
            grid-template-areas:
                "table-1 table-2 table-3 table-4"
                "desk    table-6 board   table-5";
            /* Make the first column (for Table 1/Desk) a bit wider, like the image */
            grid-template-columns: 1.2fr 1fr 1fr 1fr;
            grid-template-rows: auto auto; /* Rows size to content */
            gap: 20px;
            margin-top: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 12px;
        }
        
        /* New styles for the placeholder grid items */
        .grid-placeholder {
            border-radius: 10px;
            background-color: #eee;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 500;
            color: #777;
            padding: 20px;
            min-height: 150px;
        }
        .teacher-desk { grid-area: desk; }
        .smart-board { grid-area: board; }


        .table-group {
            background-color: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            /* REMOVED flex properties */
            box-sizing: border-box;
            min-width: 0; /* Let grid control the width */
            min-height: 150px; /* Match placeholder height */
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        @media (max-width: 768px) {
            /* UPDATED: Stack grid on mobile */
            #tablesContainer {
                grid-template-areas:
                    "table-1"
                    "table-2"
                    "table-3"
                    "table-4"
                    "table-5"
                    "table-6"
                    "desk"
                    "board";
                grid-template-columns: 1fr; /* Single column */
                grid-template-rows: auto;
            }
            .table-group, .grid-placeholder {
                min-height: 100px;
                min-width: 250px; /* Give them a min-width again on mobile */
            }
        }

        @media (max-width: 500px) {
            .table-group, .grid-placeholder {
                flex: 1 1 100%;
                min-width: 0; /* Let flex control */
            }
        }

        @media (max-width: 500px) {
            .table-group {
                flex: 1 1 100%;
            }
            .input-section {
                flex-direction: column;
            }
        }


        .table-group h3 {
            margin-top: 0;
            color: #007aff;
            font-size: 1.3rem;
            margin-bottom: 5px; /* Reduced margin */
            pointer-events: none; /* Make text non-interactive for dragging */
            text-align: center; /* Center title */
            line-height: 1.2;
        }

        /* NEW: Style for the student count */
        .table-group h3 span.student-count {
            display: block;
            font-size: 0.9rem;
            color: #555;
            font-weight: 500;
            margin-top: 4px;
        }

        .table-group ol {
            padding-left: 20px;
            margin: 0;
            list-style-type: decimal;
            width: 100%;
            min-height: 50px; /* Make empty lists a valid drop target */
            border-radius: 6px;
        }

        .table-group li {
            font-size: 1.05rem;
            padding: 8px 6px;
            border-bottom: 1px solid #f9f9f9;
            cursor: move; /* Indicates item is draggable */
            transition: opacity 0.2s ease, background-color 0.2s ease;
            background-color: #fff;
            border-radius: 4px;
            margin-bottom: 2px;
        }
        
        .table-group li:last-child {
            border-bottom: none;
        }

        /* --- Drag and Drop Styles --- */
        li.dragging {
            opacity: 0.4; /* Make the dragged item semi-transparent */
        }
        
        .table-group.drag-over {
            background-color: #e6f7ff; /* Highlight drop target */
            border-color: #007aff;
        }
        .table-group.drag-over-full {
             background-color: #ffebee; /* Highlight when target is full */
            border-color: #f44336;
        }


        #emptyState {
            text-align: center;
            color: #777;
            margin-top: 30px;
            font-style: italic;
        }
    </style>
</head>
<body>

    <main>
        <!-- UPDATED Version Number -->
        <h1>Classroom Table Sorter üë®‚Äçüè´ <span class="version">v1.9.67</span></h1>
        
        <div class="sheet-input">
            <label for="sheetUrl">Import from Google Sheet:</label>
            <p>Publish your sheet to the web as a .csv (File > Share > Publish to the web) and paste the public URL here. Your sheet's **first row must have headers** that match the period names (e.g., "1st period", "2nd period").</p>
            <input type="url" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
            
            <div class="sheet-input-controls">
                <div>
                    <label for="periodSelect" style="margin-top:10px;">Select Period:</label>
                    <select id="periodSelect">
                        <option value="">-- Select a period --</option>
                        <option value="1st period">1st period</option>
                        <option value="2nd period">2nd period</option>
                        <option value="4th period">4th period</option>
                        <option value="5th period">5th period</option>
                        <option value="8th period">8th period</option>
                    </select>
                </div>
                
                <button onclick="fetchFromSheet()">Fetch Names</button>
            </div>
            <div id="fetchStatus"></div>
        </div>

        <div classs="divider"></div>

        <div class="input-section">
            <div>
                <p><strong>...or paste names manually:</strong></p>
                <textarea id="studentNames" placeholder="Alice
Bob
Charlie
..."></textarea>
            </div>
            <div class="settings">
                <p><strong>Settings:</strong></p>
                <label for="numTables">Number of Tables:</label>
                <input type="number" id="numTables" value="6" min="1"><br><br>
                <label for="maxStudentsPerTable">Max Students per Table:</label>
                <input type="number" id="maxStudentsPerTable" value="5" min="1">
                <p class="setting-note">Note: Only tables 2, 3, and 4 can have more than 4 students. Other tables are capped at 4.</p>
            </div>
        </div>

        <button class="sort-button" onclick="sortTables()">Sort Tables!</button>

        <h2 id="resultsHeader" style="display: none;">Assigned Seating Chart (Drag names to move)</h2>
        <div id="emptyState">Enter names and click "Sort Tables!" to see the seating arrangement.</div>
        <div id="tablesContainer"></div>
    </main>

    <script>
        // --- Global state to hold sorting data ---
        let currentSeatingChart = [];
        let currentTableCaps = [];
        let statusEl; // To show messages

        // --- Drag and Drop State ---
        let draggedItem = null;
        let dragSourceTableIndex = -1;


        // NEW function to fetch and parse the Google Sheet CSV
        async function fetchFromSheet() {
            const urlInput = document.getElementById('sheetUrl');
            const url = urlInput.value;
            statusEl = document.getElementById('fetchStatus'); // Init statusEl
            const textarea = document.getElementById('studentNames');
            const selectedPeriod = document.getElementById('periodSelect').value; 

            if (!url) {
                statusEl.textContent = 'Please paste a URL first.';
                statusEl.style.color = 'red';
                return;
            }
            if (!selectedPeriod) {
                statusEl.textContent = 'Please select a period to fetch.';
                statusEl.style.color = 'red';
                return;
            }
            if (!url.includes('docs.google.com/spreadsheets') || !url.includes('pub?output=csv')) {
                 statusEl.textContent = 'Error: URL must be a "Published to the web" CSV link.';
                 statusEl.style.color = 'red';
                 return;
            }

            statusEl.textContent = 'Fetching names...';
            statusEl.style.color = '#555';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Network error: ${response.statusText}`);
                }
                localStorage.setItem('classroomSorterSheetUrl', url);
                const csvText = await response.text();
                const lines = csvText.split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV file is empty or has no data rows.');
                }
                
                const headerRow = lines[0];
                const headers = headerRow.split(',').map(h => h.trim().toLowerCase());
                const columnIndex = headers.indexOf(selectedPeriod.toLowerCase());
                
                if (columnIndex === -1) {
                    throw new Error(`Could not find a column named "${selectedPeriod}". Check your sheet's first row for matching headers.`);
                }

                const names = lines.slice(1)
                                     .map(row => {
                                        const columns = row.split(',');
                                        if (columns.length > columnIndex && columns[columnIndex]) {
                                            return columns[columnIndex].trim().replace(/"/g, ''); // Remove quotes
                                        }
                                        return ''; 
                                     })
                                     .filter(name => name.length > 0);

                if (names.length === 0) {
                    throw new Error(`No names found in the "${selectedPeriod}" column.`);
                }
                
                textarea.value = names.join('\n');
                statusEl.textContent = `Successfully imported ${names.length} names!`;
                statusEl.style.color = 'green';

            } catch (error) {
                console.error('Fetch error:', error);
                statusEl.textContent = `Error: Could not fetch names. ${error.message}`;
                statusEl.style.color = 'red';
            }
        }

        // Main sorting function
        function sortTables() {
            const namesInput = document.getElementById('studentNames').value;
            const numTables = parseInt(document.getElementById('numTables').value);
            const maxStudentsPerTable = parseInt(document.getElementById('maxStudentsPerTable').value);

            const names = namesInput.split('\n')
                                  .map(name => name.trim())
                                  .filter(name => name.length > 0);

            statusEl = document.getElementById('fetchStatus'); // Init statusEl
            statusEl.textContent = ''; // Clear status on sort

            if (names.length === 0) {
                statusEl.textContent = 'Please enter or fetch some student names before sorting!';
                statusEl.style.color = 'red';
                return;
            }
            if (isNaN(numTables) || numTables < 1) {
                statusEl.textContent = 'Please enter a valid number of tables (1 or more).';
                statusEl.style.color = 'red';
                return;
            }
            if (isNaN(maxStudentsPerTable) || maxStudentsPerTable < 1) {
                statusEl.textContent = 'Please enter a valid max students per table (1 or more).';
                statusEl.style.color = 'red';
                return;
            }

            // Define individual table caps
            currentTableCaps = Array.from({ length: numTables }, (_, i) => {
                const tableNum = i + 1; // 1-based index
                if (tableNum === 2 || tableNum === 3 || tableNum === 4) {
                    return maxStudentsPerTable; // These tables can have the max
                } else {
                    return Math.min(4, maxStudentsPerTable); // Others capped at 4
                }
            });

            const totalCapacity = currentTableCaps.reduce((acc, cap) => acc + cap, 0);

            if (names.length > totalCapacity) {
                statusEl.textContent = `Error: You have ${names.length} students but only capacity for ${totalCapacity} based on table rules. Adjust settings.`;
                statusEl.style.color = 'red';
                return;
            }

            // Shuffle the names
            for (let i = names.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [names[i], names[j]] = [names[j], names[i]];
            }

            // Distribute students
            const tables = Array.from({ length: numTables }, () => []);
            let currentTableIndex = 0;
            names.forEach(name => {
                tables[currentTableIndex].push(name);
                currentTableIndex = (currentTableIndex + 1) % numTables;
            });

            // Re-distribute to respect *individual* table caps
            let needsRebalancing = true;
            let rebalanceLoopGuard = 0; 
            while(needsRebalancing && rebalanceLoopGuard < (names.length * 2)) {
                needsRebalancing = false;
                rebalanceLoopGuard++;
                
                for (let i = 0; i < tables.length; i++) {
                    const currentTableCap = currentTableCaps[i]; 
                    
                    while (tables[i].length > currentTableCap) { 
                        needsRebalancing = true;
                        const studentToMove = tables[i].pop();
                        
                        let targetTableIndex = -1;
                        let minStudents = maxStudentsPerTable + 1; 

                        for (let j = 0; j < tables.length; j++) {
                            const targetCap = currentTableCaps[j];
                            if (tables[j].length < targetCap && tables[j].length < minStudents) {
                                minStudents = tables[j].length;
                                targetTableIndex = j;
                            }
                        }

                        if (targetTableIndex !== -1) {
                            tables[targetTableIndex].push(studentToMove);
                        } else {
                            console.warn("Could not find a place for student after rebalancing.");
                            tables[i].push(studentToMove);
                            needsRebalancing = false; 
                            break; 
                        }
                    }
                }
            }
            
            // Save to global state and render
            currentSeatingChart = tables;
            renderTables(currentSeatingChart);

            // Show results header and hide empty state
            document.getElementById('resultsHeader').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        /**
         * NEW: Renders the tables and attaches all DnD event listeners
         */
        function renderTables(tables) {
            const tablesContainer = document.getElementById('tablesContainer');
            // Clear previous render AND add placeholders
            tablesContainer.innerHTML = `
                <div class="grid-placeholder teacher-desk">Mr. Heine</div>
                <div class="grid-placeholder smart-board">Smart Board</div>
            `;

            tables.forEach((tableStudents, index) => {
                const tableGroup = document.createElement('div');
                tableGroup.className = 'table-group';
                tableGroup.dataset.tableIndex = index; // Store index
                
                /* NEW: Assign table to its grid area */
                /* We add 1 because CSS grid areas are 1-based, index is 0-based */
                tableGroup.style.gridArea = `table-${index + 1}`;

                const tableTitle = document.createElement('h3');
                /* UPDATED: Use innerHTML for two lines */
                tableTitle.innerHTML = `Table ${index + 1} <span class="student-count">(${tableStudents.length} students)</span>`;
                tableGroup.appendChild(tableTitle);

                const studentList = document.createElement('ol');
                studentList.dataset.tableIndex = index; // Store index
                
                if (tableStudents.length > 0) {
                    tableStudents.forEach(student => {
                        const li = document.createElement('li');
                        li.textContent = student;
                        li.draggable = true;
                        li.dataset.studentName = student; // Store name
                        
                        // Add drag listeners to each student item
                        li.addEventListener('dragstart', handleDragStart);
                        li.addEventListener('dragend', handleDragEnd);
                        
                        studentList.appendChild(li);
                    });
                }
                tableGroup.appendChild(studentList);

                // Add drop listeners to the table group
                tableGroup.addEventListener('dragover', handleDragOver);
                tableGroup.addEventListener('dragenter', handleDragEnter);
                tableGroup.addEventListener('dragleave', handleDragLeave);
                tableGroup.addEventListener('drop', handleDrop);

                /* UPDATED: Append to container (placeholders are already there) */
                tablesContainer.appendChild(tableGroup);
            });
        }


        // --- Drag and Drop Event Handlers ---

        function handleDragStart(e) {
            draggedItem = e.target;
            dragSourceTableIndex = parseInt(draggedItem.closest('.table-group').dataset.tableIndex, 10);
            
            // Set data (student name)
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItem.dataset.studentName);

            // Add visual cue
            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            // Clean up visual cues
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            draggedItem = null;
            dragSourceTableIndex = -1;
            
            // Remove all drop highlights
            document.querySelectorAll('.table-group.drag-over, .table-group.drag-over-full').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-full');
            });
        }

        /* UPDATED: handleDragOver now manages visual feedback */
        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const dropTarget = e.target.closest('.table-group');
            
            // If not over a valid table, do nothing and show 'no-drop' cursor
            if (!dropTarget) {
                e.dataTransfer.dropEffect = 'none';
                return;
            }

            // Remove highlights from all *other* tables
            document.querySelectorAll('.table-group.drag-over, .table-group.drag-over-full').forEach(el => {
                if (el !== dropTarget) {
                    el.classList.remove('drag-over', 'drag-over-full');
                }
            });

            const toTableIndex = parseInt(dropTarget.dataset.tableIndex, 10);
            
            // Gracefully handle if table data isn't ready
            if (isNaN(toTableIndex) || !currentTableCaps[toTableIndex] || !currentSeatingChart[toTableIndex]) {
                 e.dataTransfer.dropEffect = 'none';
                 return;
            }
            
            const toTableCap = currentTableCaps[toTableIndex];
            const toTableCurrentSize = currentSeatingChart[toTableIndex].length;

            // Show 'full' highlight
            if (toTableCurrentSize >= toTableCap && dragSourceTableIndex !== toTableIndex) {
                dropTarget.classList.add('drag-over-full');
                dropTarget.classList.remove('drag-over');
                e.dataTransfer.dropEffect = 'no-drop';
            } else { // Show 'allowed' highlight
                dropTarget.classList.add('drag-over');
                dropTarget.classList.remove('drag-over-full');
                e.dataTransfer.dropEffect = 'move';
            }
        }

        /* UPDATED: handleDragEnter is now simpler */
        function handleDragEnter(e) {
            e.preventDefault();
            // Logic is now in handleDragOver for smoother feedback
        }

        /* UPDATED: handleDragLeave now checks if we left the container */
        function handleDragLeave(e) {
            const dropTarget = e.target.closest('.table-group');
            if (dropTarget) {
                // Check if we're leaving the container entirely
                if (!e.relatedTarget || !dropTarget.contains(e.relatedTarget)) {
                    dropTarget.classList.remove('drag-over', 'drag-over-full');
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation(); // Stop browser from redirecting
            statusEl.textContent = ''; // Clear any old errors

            const dropTarget = e.target.closest('.table-group');
            if (!dropTarget || !draggedItem) return;

            const toTableIndex = parseInt(dropTarget.dataset.tableIndex, 10);
            const studentName = e.dataTransfer.getData('text/plain');
            
            // --- Validation and Data Update ---

            // 1. Check if dropping in the same table
            if (dragSourceTableIndex === toTableIndex) {
                return; // No change needed
            }

            // 2. Check capacity rules
            const toTableCap = currentTableCaps[toTableIndex];
            const toTableCurrentSize = currentSeatingChart[toTableIndex].length;

            if (toTableCurrentSize >= toTableCap) {
                statusEl.textContent = `Error: Table ${toTableIndex + 1} is full (Max: ${toTableCap}).`;
                statusEl.style.color = 'red';
                return; // Abort drop
            }

            // 3. Update the data model (currentSeatingChart)
            // Remove from old table
            const studentIndex = currentSeatingChart[dragSourceTableIndex].indexOf(studentName);
            if (studentIndex > -1) {
                currentSeatingChart[dragSourceTableIndex].splice(studentIndex, 1);
            }

            // Add to new table
            currentSeatingChart[toTableIndex].push(studentName);

            // 4. Re-render the entire chart
            renderTables(currentSeatingChart);
        }

        // Run once on load
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('emptyState').style.display = 'block';
             document.getElementById('resultsHeader').style.display = 'none';
             statusEl = document.getElementById('fetchStatus'); // Init statusEl

             const savedUrl = localStorage.getItem('classroomSorterSheetUrl');
             if (savedUrl) {
                document.getElementById('sheetUrl').value = savedUrl;
             }
        });
    </script>

</body>
</html>


